services:
  # ---------------------------------------
  # 1. Backend Service
  # ---------------------------------------
  - type: web
    name: chaintorque-backend
    env: bun
    plan: free
    buildCommand: cd backend && bun install && bun run compile
    startCommand: cd backend && bun run start
    branch: main
    envVars:
      - key: NODE_ENV
        value: production
      - key: MONGODB_URI
        sync: false
      - key: RPC_URL
        sync: false
      - key: PRIVATE_KEY
        sync: false
      - key: CONTRACT_ADDRESS
        sync: false
      - key: CLERK_PUBLISHABLE_KEY
        sync: false

  # ---------------------------------------
  # 2. Marketplace Frontend (Web Wrapper)
  # ---------------------------------------
  - type: web
    name: chaintorque-marketplace
    env: bun
    plan: free
    buildCommand: cd "Marketplace (Frontend)" && bun install && bun run build
    # Serve dist folder on port 10000 (Render default) or $PORT if available. 
    # --single supports SPA routing (rewrites 404 to index.html)
    startCommand: cd "Marketplace (Frontend)" && bun x serve dist --single --listen ${PORT:-10000}
    branch: main
    envVars:
      - key: VITE_API_URL
        fromService:
          type: web
          name: chaintorque-backend
          property: url
      - key: VITE_CLERK_PUBLISHABLE_KEY
        sync: false

  # ---------------------------------------
  # 3. Landing Page Frontend (Web Wrapper)
  # ---------------------------------------
  - type: web
    name: chaintorque-landing
    env: bun
    plan: free
    buildCommand: cd "Landing Page (Frontend)" && bun install && bun run build
    startCommand: cd "Landing Page (Frontend)" && bun x serve dist --single --listen ${PORT:-10000}
    branch: main
    envVars:
      - key: VITE_CLERK_PUBLISHABLE_KEY
        sync: false

  # ---------------------------------------
  # 4. CAD Frontend (Web Wrapper)
  # ---------------------------------------
  - type: web
    name: chaintorque-cad
    env: bun
    plan: free
    buildCommand: cd "CAD (Frontend)" && bun install && bun run build
    # CRA builds to 'build' folder, not 'dist'
    startCommand: cd "CAD (Frontend)" && bun x serve build --single --listen ${PORT:-10000}
    branch: main
