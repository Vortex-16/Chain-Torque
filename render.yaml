services:
  # ---------------------------------------
  # 1. Backend Service (Web Service)
  # ---------------------------------------
  - type: web
    name: chaintorque-backend
    env: bun
    plan: free
    buildCommand: cd backend && bun install && bun run compile
    startCommand: cd backend && bun run start
    branch: main
    envVars:
      - key: NODE_ENV
        value: production
      - key: MONGODB_URI
        sync: false
      - key: RPC_URL
        sync: false
      - key: PRIVATE_KEY
        sync: false
      - key: CONTRACT_ADDRESS
        sync: false
      - key: CLERK_PUBLISHABLE_KEY
        sync: false

  # ---------------------------------------
  # 2. Marketplace Frontend (Static Site)
  # ---------------------------------------
  - type: web
    name: chaintorque-marketplace
    env: static
    buildCommand: cd "Marketplace (Frontend)" && bun install && bun run build
    publishDir: "Marketplace (Frontend)/dist"
    branch: main
    routes:
      - type: rewrite
        source: /**
        destination: /index.html
    envVars:
      - key: VITE_API_URL
        fromService:
          type: web
          name: chaintorque-backend
          property: url
      - key: VITE_CLERK_PUBLISHABLE_KEY
        sync: false

  # ---------------------------------------
  # 3. Landing Page Frontend (Static Site)
  # ---------------------------------------
  - type: web
    name: chaintorque-landing
    env: static
    buildCommand: cd "Landing Page (Frontend)" && bun install && bun run build
    publishDir: "Landing Page (Frontend)/dist"
    branch: main
    envVars:
      - key: VITE_CLERK_PUBLISHABLE_KEY
        sync: false

  # ---------------------------------------
  # 4. CAD Frontend (Static Site - CRA)
  # ---------------------------------------
  - type: web
    name: chaintorque-cad
    env: static
    buildCommand: cd "CAD (Frontend)" && bun install && bun run build
    publishDir: "CAD (Frontend)/build"
    branch: main
    routes:
      - type: rewrite
        source: /**
        destination: /index.html
